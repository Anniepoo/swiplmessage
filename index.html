<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title>Error Handling and Messages in SWI-Prolog</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


/*
 * Theme specific overrides of the preceding (asciidoc.css) CSS.
 *
 */
body {
  font-family: Garamond, Georgia, serif;
  font-size: 17px;
  color: #3E4349;
  line-height: 1.3em;
}
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Garmond, Georgia, serif;
  font-weight: normal;
  border-bottom-width: 0;
  color: #3E4349;
}
div.title, caption.title { color: #596673; font-weight: bold; }
h1 { font-size: 240%; }
h2 { font-size: 180%; }
h3 { font-size: 150%; }
h4 { font-size: 130%; }
h5 { font-size: 115%; }
h6 { font-size: 100%; }
#header h1 { margin-top: 0; }
#toc {
  color: #444444;
  line-height: 1.5;
  padding-top: 1.5em;
}
#toctitle {
  font-size: 20px;
}
#toc a {
    border-bottom: 1px dotted #999999;
    color: #444444 !important;
    text-decoration: none !important;
}
#toc a:hover {
    border-bottom: 1px solid #6D4100;
    color: #6D4100 !important;
    text-decoration: none !important;
}
div.toclevel1 { margin-top: 0.2em; font-size: 16px; }
div.toclevel2 { margin-top: 0.15em; font-size: 14px; }
em, dt, td.hdlist1 { color: black; }
strong { color: #3E4349; }
a { color: #004B6B; text-decoration: none; border-bottom: 1px dotted #004B6B; }
a:visited { color: #615FA0; border-bottom: 1px dotted #615FA0; }
a:hover { color: #6D4100; border-bottom: 1px solid #6D4100; }
div.tableblock > table, table.tableblock { border: 3px solid #E8E8E8; }
th.tableblock, td.tableblock { border: 1px solid #E8E8E8; }
ul > li > * { color: #3E4349; }
pre, tt, .monospaced { font-family: Consolas,Menlo,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; }
tt, .monospaced { font-size: 0.9em; color: black;
}
div.exampleblock > div.content, div.sidebarblock > div.content, div.listingblock > div.content { border-width: 0 0 0 3px; border-color: #E8E8E8; }
div.verseblock { border-left-width: 0; margin-left: 3em; }
div.quoteblock { border-left-width: 3px; margin-left: 0; margin-right: 0;}
div.admonitionblock td.content { border-left: 3px solid #E8E8E8; }


div.imageblock {
	float: right;
	margin-left: 8px;
}


@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Error Handling and Messages in SWI-Prolog</h1>
<span id="author">Anne Ogborn</span><br />
<span id="email"><code>&lt;<a href="mailto:annie66us@yahoo.com">annie66us@yahoo.com</a>&gt;</code></span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p><a href="/swipltuts/index.html">Up to All Tutorials</a></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_about_this_tutorial">1. About This Tutorial</h2>
<div class="sectionbody">
<div class="paragraph"><p>Every useful library will, sooner or later, encounter an abnormal condition, like a missing file, that the library itself can&#8217;t handle. The usual reaction of the program is often to somehow display an error message.</p></div>
<div class="paragraph"><p>Simply printing unstructured text out stderr is inconvenient for library users who may need to handle the condition programmatically, translate the message, or display the message elsewhere, like a GUI or web page.</p></div>
<div class="paragraph"><p>This tutorial is about handling such conditions properly, especially in libraries, using a system borrowed from Quintus Prolog and enshrined in the ISO Prolog standard. It is particularly important for authors of packs to follow this method, and not simply use format/3.</p></div>
<div class="paragraph"><p>It should take most programmers well under an hour.</p></div>
<div class="paragraph"><p>This tutorial should be accessible to any programmer who understands the basics of Prolog. While this tutorial is about SWI-Prolog&#8217;s implementation, it should apply to most near ISO Prologs.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_the_pipeline">2. The Pipeline</h2>
<div class="sectionbody">
<div class="paragraph"><p>Message handling follows a pipeline. The rest of this tutorial explores that pipeline in detail, but here&#8217;s a simplified version</p></div>
<div class="paragraph"><p>A <em>message</em> enters the pipeline through <code>print_message/1</code> , either because <code>print_message/1</code> was called by the application programmer, or because an exception wasn&#8217;t caught. The top-level handles all otherwise not caught exceptions by passing them to <code>print_message/1</code>.</p></div>
<div class="paragraph"><p>The format of a message is the same as the standardized format of an exception. Since Prolog is typeless, a message is, effectively, just an exception term.</p></div>
<div class="paragraph"><p>A pipeline with lots of hooks produces a list of tokens (called "lines") to be output.</p></div>
<div class="paragraph"><p>The token list is passed to another hookable predicate, <code>print_message_lines/1</code>, to be printed, sent to the web page, or whatever.</p></div>
<div class="paragraph"><p>This is the basics. Here&#8217;s the complete pipeline, in all it&#8217;s gory detail:</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/messagepipeline.svg" alt="Message Pipeline" />
</span></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_producing_a_message_term">3. Producing a Message Term</h2>
<div class="sectionbody">
<div class="paragraph"><p>The message pipeline starts with a <em>semantic_message</em> .</p></div>
<div class="sect2">
<h3 id="_semantic_messages">3.1. Semantic Messages</h3>
<div class="paragraph"><p>A <em>semantic_message</em> is a compound term that defines the message in terms of it&#8217;s meaning, or <em>semantics</em> , instead of creating a string representation.</p></div>
<div class="paragraph"><p>For example, here&#8217;s the term that means "File Not Found"</p></div>
<div class="listingblock">
<div class="content">
<pre><code>        3 ?- catch(open('nosuchfile.txt', read, _), E, true).
        E = error(existence_error(source_sink, 'nosuchfile.txt'), context(system:open/3, 'No such file or directory')).</code></pre>
</div></div>
<div class="paragraph"><p>Semantically, E means something like  "An error, specifically that source_sink nosuchfile.txt doesn&#8217;t exist. This happened in <code>system:open/3</code> . A good error message might be <em>No such file or directory</em> "</p></div>
<div class="paragraph"><p>Which is a lot more flexible than the string <em>No such file or directory</em> . By having hooks in the pipeline, set up by the application programmer, do the translation, the library programmer isn&#8217;t forcing his or her way on the application programmer. The application programmer can print "Bestand of map bestaat niet", log the error, or whatever&#8217;s appropriate.</p></div>
<div class="paragraph"><p>To let the handler <em>understand</em> the term, we need to restrict its form. As you&#8217;ve already seen, the SWI-Prolog libraries throw compound terms. These terms are defined in the <a href="">http://www.deransart.fr/prolog/exceptions.html</a>[ISO Standard] exception set. I encourage having this page open during this tutorial, and bookmarking it and referring to it when writing Prolog code.</p></div>
<div class="paragraph"><p><em>error</em> means that this is an error. You might also want to use this mechanism to display messages from the library that aren&#8217;t errors. Such messages might have another outer functor.</p></div>
<div class="paragraph"><p>The ISO messages cover most possible errors. The first argument must conform to the ISO standard. The second term is <em>implementation dependent</em>, but is often a context term whose first argument is the signature of the throwing predicate, and whose second is an English representation of the error.</p></div>
<div class="paragraph"><p>There is one other message you should know about, but avoid using.
The message <code>format(Format, ArgList)</code> is predefined to translate to the string that would result from <code>format/2</code>.</p></div>
<div class="paragraph"><p>Don&#8217;t do this. It short circuits the whole idea of a semantic error term.</p></div>
<div class="paragraph"><p>Finally, there&#8217;s a message form <code>debug/2</code>, which is produced by the <code>debug/3</code> predicate and handled by the debug message system.</p></div>
<div class="paragraph"><p>Exercise: Generate a half dozen error terms by doing illegal things in SWI-Prolog and catching the error, like above.</p></div>
<div class="paragraph"><p>Exercise: Imagine you&#8217;re writing a library to connect to an external service, say an LDAP server. Use the linked page above and figure out what ISO error term should be thrown if the server can&#8217;t be reached.</p></div>
<div class="paragraph"><p>Exercise: Take a library you&#8217;ve written, preferably in Prolog, but in any language, and look through it for an error message. How is the message constructed? Imagine your library is being used in a dedicated machine controller with an oddball display, for sale in Japan. Will your library need modified?</p></div>
<div class="paragraph"><p>Exercise: With the same or different code, look at the normal program output code. If it instead put out semantic terms, could it be used in other situations you might not have considered when it was written?</p></div>
<div class="paragraph"><p>Exercise: When was the last time you were paid to write code that parsed output of a library because the library&#8217;s output wasn&#8217;t in a convenient format? How much were you paid? How many programmers are there in the world?</p></div>
</div>
<div class="sect2">
<h3 id="_originating_messages">3.2. Originating Messages</h3>
<div class="paragraph"><p>There are three ways of feeding a message into the pipeline.</p></div>
<div class="paragraph"><p>Messages can be sent directly by calling <code>print_message/1</code> with the message term.</p></div>
<div class="paragraph"><p>Messages result from uncaught errors that reach the top level.</p></div>
<div class="paragraph"><p>Messages can also result from calling <code>debug/3</code>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">4. Exceptions</h2>
<div class="sectionbody">
<div class="paragraph"><p>The language construct provided for abnormal conditions is, like many languages, throw and catch.</p></div>
<div class="paragraph"><p>When code detects a condition that it can&#8217;t handle on it&#8217;s own, it calls <code>throw/1</code>. The calling stack is unwound until it is <em>caught</em>, usually by a meta-predicate like <code>catch/3</code>.</p></div>
<div class="paragraph"><p>Programmers familiar with Java will recognize this mechanism.</p></div>
<div class="listingblock">
<div class="title">Some Examples of Exceptions</div>
<div class="content">
<pre><code>1 ?- catch(throw(taco), C, writeln(C)).    <img src="./images/icons/callouts/1.png" alt="1" />
taco
C = taco.

2 ?- catch(X is 3 / 1, C, writeln(C)).   <img src="./images/icons/callouts/2.png" alt="2" />
X = 3.

3 ?- catch(fail, C, writeln(C)).   <img src="./images/icons/callouts/3.png" alt="3" />
false.

11 ?- catch(X is 3 / 0, C, fail).   <img src="./images/icons/callouts/4.png" alt="4" />
false.

4 ?- catch(throw(taco), burrito, writeln(C)). <img src="./images/icons/callouts/5.png" alt="5" />
ERROR: Unhandled exception: taco

5 ?- catch(X is 3 / 0 , C, writeln(C)).   <img src="./images/icons/callouts/6.png" alt="6" />
error(evaluation_error(zero_divisor),context((/)/2,_G1943))   <img src="./images/icons/callouts/7.png" alt="7" />
C = error(evaluation_error(zero_divisor), context((/)/2, _G1943)).

6 ?- catch(open(_, _, _) , C, writeln(C)).    <img src="./images/icons/callouts/8.png" alt="8" />
error(instantiation_error,context(system:open/3,_G2488))
C = error(instantiation_error, context(system:open/3, _G2488)).

7 ?- catch(open(3, read, _) , C, writeln(C)).    <img src="./images/icons/callouts/9.png" alt="9" />
error(type_error(text,3),context(system:open/3,_G3054))
C = error(type_error(text, 3), context(system:open/3, _G3054)).

% defined in a file
foo(X, Y) :- Y is 3 / X.
bar(X, Y) :- foo(X, Y).

8 ?- catch(bar(0, Y), C, writeln(C)).      <img src="./images/icons/callouts/10.png" alt="10" />
error(evaluation_error(zero_divisor),context((/)/2,_G1943))
C = error(evaluation_error(zero_divisor), context((/)/2, _G1943)).</code></pre>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
We explicitly call throw. <em>taco</em> is an arbitrary term that is returned as C. <code>catch/3</code>
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Where&#8217;s the output?  We don&#8217;t throw, so we don&#8217;t call the goal in the third argument
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
When the first argument goal fails, catch fails
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
If the third argument goal fails after the first argument has thrown, catch fails.
</td></tr>
<tr><td><img src="./images/icons/callouts/5.png" alt="5" /></td><td>
Throw is caught only when the second argument of <code>catch/3</code> unifies. Here it doesn&#8217;t, so we continue up the stack to the top level, which displays an error message.
</td></tr>
<tr><td><img src="./images/icons/callouts/6.png" alt="6" /></td><td>
We don&#8217;t explicitly call throw, but the <code>/</code> operator throws if it&#8217;s divisor is zero.
</td></tr>
<tr><td><img src="./images/icons/callouts/7.png" alt="7" /></td><td>
This time C is a complex term. We&#8217;ll learn about this term in the section <em>ISO Exceptions</em>
</td></tr>
<tr><td><img src="./images/icons/callouts/8.png" alt="8" /></td><td>
Calling open with a request to open some file whose name we don&#8217;t know, in a mode we&#8217;re not sure of, isn&#8217;t realistic. The first two arguments of <code>open/3</code> need to be instantiated. The thrown term contains <code>instantiation_error</code>.
</td></tr>
<tr><td><img src="./images/icons/callouts/9.png" alt="9" /></td><td>
Lets try calling open with 3 as a filename. Nope - can&#8217;t use a number as a filename. It wants text, so it throws a type_error.
</td></tr>
<tr><td><img src="./images/icons/callouts/10.png" alt="10" /></td><td>
bar calls foo, which throws. We unwind all the way back to the catch.
</td></tr>
</table></div>
<div class="sect2">
<h3 id="_catching_exceptions">4.1. Catching Exceptions</h3>
<div class="paragraph"><p>As we&#8217;ve seen above, <code>catch/3</code> takes a goal as it&#8217;s first and third arguments. If we call <code>catch(A, B, C)</code></p></div>
<div class="paragraph"><p>If</p></div>
<div class="ulist"><ul>
<li>
<p>
A succeeds: the catch succeeds.
</p>
</li>
<li>
<p>
A fails: the catch fails
</p>
</li>
<li>
<p>
A throws a term that unifies with B: calls C as in <code>call/1</code>
</p>
</li>
<li>
<p>
A throws a term that doesn&#8217;t unify with B: the catch doesn&#8217;t catch - the throw <em>goes through</em> the catch (rethrows)
</p>
<div class="literalblock">
<div class="content">
<pre><code>There are a couple convenient metapredicates that act much like the try-catch-finally in languages that use coffee analogies: +setup_call_catcher_cleanup(:Setup, :Goal, +Catcher, :Cleanup)+ and +setup_call_cleanup(:Setup, :Goal, +Catcher, :Cleanup)+</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>=== Decorating Exceptions</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>Of course we might want to grab some additional information on the way out. You can decorate the exception with +prolog_exception_hook/2+ .
The stack trace is the obvious thing to add, but you might want other control.</code></pre>
</div></div>
</li>
</ul></div>
<div class="paragraph"><p>Exercise: Type in the prolog above, trying the various ways to throw</p></div>
<div class="paragraph"><p>Exercise: Type catch into the SWI-Prolog website search box, and look at some of the options that come up</p></div>
<div class="paragraph"><p>Exercise: You&#8217;ve written a nifty machine learning system that requires a training file, training.data. Users pass your system file names and you analyze them somehow. You&#8217;ve released your creation, and are getting an annoying number of support queries from users who don&#8217;t have a training file in the right place.</p></div>
<div class="paragraph"><p>Write a small facade that detects when the thrown exception is missing file because it can&#8217;t find the training file, and when the user&#8217;s asked for a nonexistant file to be analyzed. Have it throw two different ISO standard exceptions that make it clear to the user when the file they&#8217;re missing is the training data.</p></div>
<div class="paragraph"><p>Do this in two different ways: Rethrow a new exception, and use the exception hook.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_converting_messages_to_strings">5. Converting Messages to Strings</h2>
<div class="sectionbody">
<div class="paragraph"><p>Earlier we tried catching the error term. What happens if we don&#8217;t?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   1 ?- open('nosuchfile.txt', read, _).
ERROR: open/3: source_sink 'nosuchfile.txt' does not exist (No such file or directory)</code></pre>
</div></div>
<div class="paragraph"><p>OK, where&#8217;d that error message come from? Much more readable than the message term, but we have to convert from one to the other. And there&#8217;s the rub. Lets handle that next.</p></div>
<div class="paragraph"><p>[<a href="http://www.swi-prolog.org/pldoc/doc_for?object=print_message/2]"><code>print_message/2</code></a> takes two arguments, the kind of message and the message term.</p></div>
<div class="paragraph"><p>The kind of message is an atom that describes what general kind of message it is. There are lots of kinds of message, and we leave you to check them out.  An often overlooked kind is <code>help</code> .</p></div>
<div class="paragraph"><p>Well, what really happens next is translating from the message term to a list of <em>tokens</em>. In the simplest case, these tokens are atoms that will become lines of output. This is the point where semantics becomes words.</p></div>
<div class="paragraph"><p>The translation process uses the multifile DCG <code>prolog:message//1</code> .</p></div>
<div class="paragraph"><p><code>prolog:message//1</code> is called using phrase, and passing the message term as it&#8217;s semantic argument. If it succeeds, the list it generates will be the token list.</p></div>
<div class="paragraph"><p>Some messages are predefined in SWI-Prolog. They&#8217;re a good example of <code>prolog:message//1</code>. Here&#8217;s some of them defined in license.pl :</p></div>
<div class="listingblock">
<div class="content">
<pre><code>        :- multifile
                prolog:message/3.

        prolog:message(unknown_license(License)) --&gt;
                [ 'Unknown license: ~w.  Known licenses are:'-[License], nl ],
                license_list.
        prolog:message(license(gpl, Modules)) --&gt;
                [ 'This system may only distributed using the GNU General Public License', nl,
                  'because the following components contain GPL-ed code:', nl, nl
                ],
                file_list(Modules),
                see_also.
        prolog:message(license(lgpl)) --&gt;
                [ 'This program may be distributed under any license, provided all', nl,
                  'conditions implied by the GNU Lesser General Public License', nl,
                  'are satisfied.  In particular, this implies the source code', nl,
                  'to any modification in SWI-Prolog or one of the used libraries', nl,
                  'must be made available.', nl
                ],
                see_also.
        prolog:message(license(proprierary(L), Modules)) --&gt;
                { license(L, _, Att) },
                {   memberchk(comment(C), Att)
                -&gt;  true
                ;   C = L
                },
                [ nl,
                  'The program contains modules covered by the "~w" license'-[C], nl
                ],
                (   { memberchk(url(URL), Att) }
                -&gt;  [ 'See ~w'-[URL], nl ]
                ;   []
                ),
                [ nl ],
                file_list(Modules).</code></pre>
</div></div>
<div class="paragraph"><p>Notice that not every element of the list is an atom. <code>print_message_lines/3</code> defines a number of tokens. Here&#8217;s some of them:</p></div>
<div class="ulist"><ul>
<li>
<p>
&lt;format&gt;-&lt;args&gt;  Where Format is an atom and Args is a list of format arguments. Handed to format/3.
</p>
</li>
<li>
<p>
flush            Flush the output. Suppress the final newline
</p>
</li>
<li>
<p>
some ansi coloring related tokens - see the docs
</p>
</li>
<li>
<p>
nl  start a new line of the message
</p>
</li>
</ul></div>
<div class="paragraph"><p>Defining your own messages and default <code>prolog:message//1</code> handlers can make your library much more powerful.</p></div>
<div class="paragraph"><p>Exercise: Use the last exercise in the last set (the training.data problem). Define a clear message for the user explaining how to get a training file, using the message/1 mechanism</p></div>
<div class="paragraph"><p>Exercise: Look through your own Prolog code for what terms you throw.</p></div>
<div class="paragraph"><p>Exercise: Take a small console <em>hack</em> you&#8217;ve written and clean it up so it uses the message system to display it&#8217;s output.</p></div>
<div class="paragraph"><p>Exercise: Define a message type, and <code>prolog:message//1</code> handler for it that produces some reasonable message using every kind of token you can from <code>print_message_lines/3</code>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_producing_output">6. Producing Output</h2>
<div class="sectionbody">
<div class="paragraph"><p>We now have a list of tokens. We can, if we want, get a string at this point by calling <code>message_to_string/2</code>.</p></div>
<div class="paragraph"><p>All that&#8217;s left is to actually display the output to the user in a way appropriate for the application.</p></div>
<div class="paragraph"><p>The pipeline can be hooked at this point. If the hook succeeds, it&#8217;s handled the printing, or flag waving, or whatever output, and the pipeline ends. If not, it&#8217;s passed onto <code>print_message_lines/3</code> for processing.</p></div>
<div class="paragraph"><p>But, there are actually <strong>two</strong> hooks. The first checked is a thread_local hook predicate, <code>thread_message_hook/3</code>. The second is <code>message_hook/2</code>. So messages can be handled differently, for example, if they&#8217;re on an HTTP handler thread than if they&#8217;re on backend threads.</p></div>
<div class="paragraph"><p>Both take the same 3 arguments: The message term, the kind of message (from <code>print_message/2</code>) and the list of tokens.</p></div>
<div class="paragraph"><p>If we&#8217;re going to print it somehow, <code>message_to_string/2</code> will give us the string, and we output it however&#8217;s appropriate. That could be munging the output somehow and passing it to <code>print_message_lines/3</code>, or it could be something completely different.</p></div>
<div class="paragraph"><p>If the hooks fail, the message goes to <code>print_message_lines/3</code>, which takes a stream to print on, a prefix to prepend on every line, and the list of tokens. The prefix is probably something like the current mode or module.</p></div>
<div class="paragraph"><p>Notice that the kind isn&#8217;t passed to <code>print_message_lines/3</code>. We can influence the way <code>print_message_lines/3</code> prints, depending on kind, by using <code>message_property/2</code>. This is how we can get things like WARNING on the front of the line. A very useful option to <code>message_property/2</code> is location_prefix, which allows printing the source file and line number if it&#8217;s set before the process is set off.</p></div>
<div class="paragraph"><p>You can also set the stream to output to, and have the system wait after displaying the message.</p></div>
<div class="paragraph"><p>Exercise: Make a little console quiz program that asks a few questions about animals. Keep a score in a file, and color questions, answers, and correct and incorrect feedback different colors. All output from the program should go through the message pipeline.</p></div>
<div class="paragraph"><p>Exercise: Without touching the console version, make it work in a web page.</p></div>
<div class="paragraph"><p>Exercise: Find a piece of Prolog code you like and clean it up so it passes all output through the pipeline. Provide appropriate default <code>message//1</code>, and perhaps contextual coloring for output.</p></div>
<div class="paragraph"><p>Exercise: Sit around a bit and try to think up cool, out of the box uses for the message pipeline.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_takeaway">7. Takeaway</h2>
<div class="sectionbody">
<div class="paragraph"><p>Don&#8217;t directly print messages from your library code with format. Use the messaging system.</p></div>
<div class="paragraph"><p>Your users will love you for it.</p></div>
<div class="paragraph"><p>Your library will become much more maintainable and reusable.</p></div>
<div class="paragraph"><p>Your teeth will be whiter, and your children smarter and better behaved.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_acknowledgements">8. Acknowledgements</h2>
<div class="sectionbody">
<div class="paragraph"><p>Thanks to Jan Wielemaker, who patiently explained some of the fine points of all this, and who first encouraged me to write this tutorial.</p></div>
<div class="paragraph"><p>Thanks to Paulo Moura, who explained a few more.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2016-05-20 08:58:27 Pacific Daylight Time
</div>
</div>
</body>
</html>
